<?php


namespace app\middelwares;

use app\core\JwtAuth;
use app\core\Middelware;
use app\core\Request;
use app\exceptions\AuthException;
use app\models\User;

class AuthMiddelware extends Middelware
{
    protected Request $request;
    function __construct(Request $request)
    {
        $this->request = $request;
    }

    public function execute(User $userAuth)
    {
        $auth = $this->isAuth($this->request->getHeader());

        if (!$auth) {
            throw new AuthException('Not authenticated');
            exit();
        };
        $user = $userAuth ?? new User();

        $user->userId = $auth['id'];

        return $user;
    }

    public function isAuth($headers)
    {
        $token = $this->checkHeaderAuth($headers);

        return $token ? JwtAuth::isAuth($token[1]) : false;
    }

    function checkHeaderAuth($headers)
    {
        if (
            isset($headers['Authorization']) &&
            $headers['Authorization'] !== "undefined" &&
            preg_match('/Bearer\s(\S+)/', $headers['Authorization'], $token)
        ) {
            return $token;
        }
    }
}
